# 台股 N 字回撤掃描器 - 產品需求文檔 (PRD)

## 1. 產品概述

### 1.1 產品願景
開發一套完整的台股技術分析工具，專門掃描「N 字回撤」形態，幫助量化交易者和技術分析師快速發現符合特定回撤規則的股票機會。

### 1.2 目標用戶
- **量化/技術分析師**：需要系統化掃描市場機會
- **個人投資者**：尋找技術形態良好的投資標的
- **程式交易員**：需要穩定的數據源和 API 接口

### 1.3 核心價值主張
- **全市場覆蓋**：上市 + 上櫃所有普通股票
- **快速掃描**：≤ 3 分鐘完成全市場掃描
- **免費數據**：使用官方免費數據源，無額外成本
- **即時更新**：每日收盤後自動更新
- **精準過濾**：只納入股票，排除 ETF/權證等衍生商品

---

## 2. 功能需求

### 2.1 核心功能模組

#### 2.1.1 數據管理模組
**功能描述**：管理台股數據的獲取、存儲和更新

**股票宇宙建構與校驗**：
- 白名單規則（精確匹配）
  - TWSE ISIN `strMode=2`: security_type='股票' AND market='TWSE'
  - TPEx ISIN `strMode=4`: security_type='股票' AND market='TPEx'
- 黑名單規則（名稱/代碼過濾）
  - 排除關鍵字：ETF、ETN、受益憑證、認購權證、認售權證、存託憑證、DR、公司債、特別股
  - 排除代碼範圍：興櫃（7000-7999）、創新板（8000-8999）
- 每日校驗 SLO
  - 上市股票數量偏差 ≤ 5%（目標 ~950檔）
  - 上櫃股票數量偏差 ≤ 5%（目標 ~800檔）
  - 新增/下市股票 ≤ 10檔/日，超出則人工確認
  - 校驗失敗 → 告警 + 使用前日清單 + 手動介入

**數據獲取流程**：
- 歷史回補：支援至少 3 年歷史日 K 數據，首次建庫批次回補
- 增量更新：每日收盤後獲取全市場 OHLC，支援上市/上櫃整批下載
- 快取策略：本地 Parquet 存儲，滾動保留近 60 天熱數據

#### 2.1.2 N 字回撤掃描模組
**功能描述**：識別符合 N 字回撤條件的股票

**詳細需求**：
- ABC 形態識別
  - A：起漲點（近期明確低點）
  - B：波段高點（須達最小漲幅要求）
  - C：回撤低點（高於 A 點，回撤幅度在指定範圍內）
- 觸發條件檢測（三擇一） ✅ 已確認
  - 條件1：收盤突破昨日高點 `close_t > high_{t-1}`
  - 條件2：量增突破 EMA5 `close_t > EMA5_t 且 volume_ratio_t > 1.5`
  - 條件3：RSI 強勢 `RSI14_t ≥ 55`
  - 多重觸發加分：兩項同中 +3 分，三項同中 +6 分（總分封頂 100）
- 綜合評分系統（0-100 分，數學化映射）
  - 回撤深度分（40%）：`40 × (1 - 2×|retr_pct - 0.5|)` （距離50%越近分越高）
  - 量能比分（25%）：`25 × min(volume_ratio / 3.0, 1.0)` （封頂3.0倍）
  - 反彈早期分（15%）：`15 × max(0, 1 - bars_since_c / 20)` （20天內線性衰減）
  - 均線多頭分（10%）：EMA5 5分 + EMA20 5分，各以 `close ≥ EMAx` 判定
  - 健康度分（10%）：RSI ∈ [50,70] 滿分，<50 或 >75 按距離扣分
  - 多重觸發獎勵：兩項 +3分，三項 +6分（總分封頂100）

#### 2.1.3 API 服務模組
**功能描述**：提供 RESTful API 供前端和外部系統調用

**API 合約規範**：

**`GET /health`** - 系統健康檢查
```json
Response 200: {
  "status": "healthy|degraded|unhealthy",
  "timestamp": "2025-01-01T16:00:00+08:00",
  "services": {
    "database": "up|down", 
    "data_sources": {"twse": "up|down", "tpex": "up|down"}
  }
}
```

**`GET /universe?date=yyyy-mm-dd`** - 獲取股票清單
```json
Response 200: {
  "date": "2025-01-01",
  "total_count": 1753,
  "markets": {"TWSE": 948, "TPEx": 805},
  "stocks": [
    {"stock_id": "2330", "name": "台積電", "market": "TWSE", "status": "normal"},
    ...
  ]
}
```

**`POST /scan`** - 執行掃描並返回結果
```json
Request: {
  "date": "2025-01-01",
  "params": {
    "lookback_bars": 200,
    "min_leg_pct": 0.04,
    "retr_min": 0.30, "retr_max": 0.70,
    "rsi_threshold": 55,
    "vol_threshold": 1.5
  }
}
Response 200: {
  "scan_date": "2025-01-01",
  "total_candidates": 47,
  "execution_time_ms": 125400,
  "results": [
    {
      "stock_id": "2330", "name": "台積電", "market": "TWSE",
      "score": 87, "retr_pct": 0.50,
      "A": {"date": "2024-11-15", "price": 770.0},
      "B": {"date": "2024-12-10", "price": 920.0},
      "C": {"date": "2024-12-20", "price": 860.0},
      "triggers": {"break_yh": true, "ema5_vol": true, "rsi_strong": true}
    }, ...
  ]
}
```

**`GET /stock/{id}/bars?start=yyyy-mm-dd&limit=150`** - 獲取個股 K 線
```json
Response 200: {
  "stock_id": "2330",
  "bars": [
    {"date": "2024-12-25", "open": 915.0, "high": 925.0, "low": 910.0, "close": 920.0, "volume": 25000}, ...
  ]
}
```

**錯誤碼規範**：
- `400`: 參數錯誤 `{"error": "INVALID_PARAM", "message": "date format should be YYYY-MM-DD"}`
- `404`: 資源不存在 `{"error": "NOT_FOUND", "message": "Stock 9999 not found"}`
- `429`: 請求過於頻繁 `{"error": "RATE_LIMIT", "message": "Max 100 req/min exceeded"}`
- `500`: 內部錯誤 `{"error": "INTERNAL_ERROR", "message": "Database connection failed"}`
- `503`: 服務不可用 `{"error": "SERVICE_UNAVAILABLE", "message": "Data source maintenance"}`

#### 2.1.4 前端展示模組
**功能描述**：提供用戶友好的 Web 界面

**頁面結構**：
- 參數設置頁面
  - 可調整掃描參數（回撤範圍、最小漲幅等）
  - 參數預設值管理
- 掃描結果列表
  - 表格展示符合條件的股票
  - 支援排序和篩選
- 個股詳細頁面
  - K 線圖展示（含 A/B/C 標註）
  - 技術指標展示
  - 參數明細說明

### 2.2 輔助功能

#### 2.2.1 排程與監控
- 每日自動排程（收盤後執行）
- 執行狀態監控
- 異常告警機制

#### 2.2.2 數據質量保證
- 數據完整性檢查
- 異常數據處理
- 停牌股票處理

---

## 3. 技術規格

### 3.1 N 字回撤演算法規格

#### 3.1.1 形態定義 ✅ 已確認
**多頭 N 字形態**：
- **A 點**：近期明確低點（起漲點）- 使用當日最低價（前復權）
- **B 點**：A 後的波段高點 - 使用當日最高價（前復權）
- **C 點**：B 後的回撤低點 - 使用當日最低價（前復權）

**成立條件**：
1. `rise_pct = (B_high - A_low) / A_low ≥ min_leg_pct` (預設4%)
2. `retr_pct = (B_high - C_low) / (B_high - A_low) ∈ [retr_min, retr_max]`
3. `C_low ≥ A_low × (1 - c_tol)`

**多重形態處理**：
- 優先選取最近一組 ABC（C 最靠近當下）
- 同日多組時決勝順序：離 50% 回撤最近 → 上漲幅度大 → 回撤天數短 → 突破日量能比大
- 可選 top_k 參數顯示多個候選形態

**確認機制**：
- 預設：收盤確認（所有觸發條件使用收盤價判定）
- 可選：盤中確認模式 `confirm_mode='intraday'`

#### 3.1.2 技術指標計算
- **EMA5**：5 日指數移動平均
- **RSI14**：14 日相對強弱指數（Wilder 方法）
- **量能比**：當日成交量 / 20 日平均量
- **ZigZag**：用於識別轉折點

#### 3.1.3 預設參數 ✅ 已確認
```
# 形態識別參數
lookback_bars = 200          # 回望天數（新股最低 80 天）
min_leg_pct = 0.04          # 最小上漲幅度 4%
retr_min = 0.30             # 最小回撤比例 30%
retr_max = 0.70             # 最大回撤比例 70%
c_tol = 0.00                # C 點容差（不可破 A）

# 技術指標參數
ema_len = 5                 # EMA 週期
rsi_len = 14                # RSI 週期
vol_ma_len = 20             # 量能均線週期
rsi_threshold = 55          # RSI 觸發閾值
vol_threshold = 1.5         # 量增倍數閾值

# 系統參數
cooldown_days = 20          # 同股重複訊號間隔
confirm_mode = 'eod'        # 確認模式：'eod'(收盤) / 'intraday'(盤中)
weekly_confirm = false      # 是否開啟週K輔助確認
top_k = 1                   # 每股最多返回候選數
```

### 3.2 數據源規格

#### 3.2.1 主要數據源
- **TWSE（上市）**：官方盤後個股行情
- **TPEx（上櫃）**：官方日收盤行情 CSV
- **備援**：FinMind API（免費額度）

#### 3.2.2 數據格式
- 存儲格式：Parquet（columnar 格式，優化查詢性能）
- 復權方式：前復權（避免除權息造成形態誤判）
- 時區：Asia/Taipei

### 3.3 性能要求

#### 3.3.1 SLO 服務等級目標

**掃描性能 SLO**：
- 全市場掃描 P95 ≤ 3 分鐘（冷啟動），P50 ≤ 90 秒（熱啟動）
- 首次歷史回補 ≤ 30 分鐘（3年數據）
- 增量更新 ≤ 5 分鐘（當日數據）

**API 響應 SLO**：
- `/scan` P95 ≤ 5 秒，P50 ≤ 2 秒
- `/stock/{id}/bars` P95 ≤ 1 秒
- `/health` P99 ≤ 100ms

**資源上限**：
- 內存峰值 ≤ 6GB（掃描期間）
- CPU 使用率 P95 ≤ 80%
- 磁盤 I/O P95 ≤ 100MB/s

**可用性 SLO**：
- 系統可用率 ≥ 99.5%（月度）
- 數據更新成功率 ≥ 99%（日度）
- API 錯誤率 ≤ 0.5%（日度）

#### 3.3.2 觀測性與監控

**核心 Metrics**：
- 業務指標：`scan_candidates_total`、`scan_execution_time`、`universe_stock_count`
- 系統指標：`api_request_duration_seconds`、`memory_usage_bytes`、`data_fetch_errors_total`
- 數據質量：`missing_data_ratio`、`price_anomaly_count`、`volume_zero_ratio`

**Logging 策略**：
- INFO: 掃描開始/結束、數據更新狀態、配置變更
- WARN: 數據缺失、校驗失敗、性能降級
- ERROR: API 錯誤、數據源失效、系統異常
- 結構化日誌：JSON 格式，包含 `timestamp`、`level`、`service`、`trace_id`、`message`

**告警規則**：
- 掃描超時 > 5 分鐘 → P2 告警
- 股票數量偏差 > 5% → P1 告警  
- API 錯誤率 > 1% (5分鐘) → P2 告警
- 系統不可用 > 1 分鐘 → P1 告警

---

## 4. 需要確認的規格細節

### 4.1 關鍵技術問題 ✅ 已確認

#### 4.1.1 N 字回撤具體判斷邏輯 ✅
**解決方案**：
- **價格口徑**：A/C 用當日最低價，B 用當日最高價（皆前復權）
- **觸發判定**：一律使用收盤價判定（降低盤中假突破）
- **多重形態**：優先取最近 ABC（C 最靠近當下），同日多組按決勝順序排序
- **確認機制**：預設收盤確認，可選盤中模式

#### 4.1.2 觸發條件的優先級 ✅
**解決方案**：
- **量增倍數**：> 1.5（平衡早期發現與覆蓋率）
- **RSI 閾值**：≥ 55（比 50 更能過濾盤整）
- **多重觸發**：兩項同中 +3 分，三項同中 +6 分
- **無優先級**：三擇一即可，多重觸發有額外加分

#### 4.1.3 時間窗口設定 ✅
**解決方案**：
- **主時框**：日 K 為主（符合 T+0 全市場掃描需求）
- **週 K 輔助**：可選功能（weekly_confirm=true 時啟用）
- **回望天數**：200 根（新股最低 80 根）
- **擴展彈性**：可調至 250-300 根，效能影響輕微

### 4.2 數據處理細節 🟡

#### 4.2.1 復權處理 ✅
**解決方案**：
- **統一前復權**：避免除權息跳空造成形態誤判
- **復權跳空**：前復權已自動調整，無需特別處理
- **特殊股利**：由數據源（FinMind）提供已處理數據，或後續擴充手動調整

#### 4.2.2 新股上市處理 ✅
**解決方案**：
- **最低門檻**：80 個交易日即可納入掃描
- **上市初期**：正常處理，波動大反而可能產生明顯 N 字形態
- **數據不足**：自動跳過，不影響其他股票掃描

### 4.3 用戶體驗設計 ✅ 已決定

#### 4.3.1 前端表格優先欄位 ✅
**設計決策**：

**預設顯示欄位**（左到右）：
1. 股票代號（可點擊跳轉明細）
2. 股票名稱
3. 評分（顯眼的數字加進度條）
4. 回撤比例（%顯示）
5. 觸發條件（圖標組合：突破/量增/RSI）
6. 信號日期
7. 操作（查看明細/導出）

**摺疊顯示（點擊展開）**：
- 市場別（TWSE/TPEx）
- A/B/C 價位
- 漲幅比例
- 量能比、RSI 值

**預設排序**：評分由高到低（可切換為信號日期、回撤比例等）

#### 4.3.2 K 線圖展示細節 ✅
**設計決策**：

**K 線圖規格**：
- **時間範圍**：150 個交易日（約 7-8 個月，平衡詳細度與效能）
- **A/B/C 標註**：
  - A 點：綠色三角形向上（起漲點）
  - B 點：紅色圓形（波段高點）
  - C 點：藍色方形（回撤低點）
- **技術指標線**：
  - EMA5：深藍色實線
  - EMA20：橙色虛線（可選顯示）
- **成交量**：下方柱狀圖，與主圖高度比 3:1
- **觸發日標註**：垂直綠色虛線 + 標籤說明

### 4.4 系統運行環境 ✅ 已決定

#### 4.4.1 部署環境 ✅
**設計決策**：

**部署策略**：
- **環境選擇**：本地開發 + Docker 容器化（便於後續雲端遷移）
- **硬體要求**：
  - CPU：4 核心以上（支援並行計算）
  - 記憶體：8GB+（Polars 大數據處理）
  - 儲存：20GB+（3 年歷史數據 + 系統檔案）
- **作業系統**：macOS/Linux 優先（Python 生態系支援佳）
- **數據儲存**：本地 SQLite + Parquet 檔案（簡單高效）

#### 4.4.2 擴展性考慮 ✅
**系統規模**：

**用戶量級**：4 人同時使用
- 並發設計：支援 10+ 同時連線
- API 限流：單用戶 100 請求/分鐘
- 緩存策略：掃描結果緩存 1 小時

**功能擴展性**：
- **第一版**：僅支援 N 字回撤、台股上市/上櫃
- **未來擴展**：
  - 其他形態：多重頂、突破箱型、旗桿形態
  - 市場擴展：興櫃、美股 ETF
  - 進階功能：回測系統、組合篩選器

---

## 5. 成功標準

### 5.1 功能完整性
- ✅ 正確識別所有上市/上櫃普通股票
- ✅ 準確計算 N 字回撤形態
- ✅ 三種觸發條件正常工作
- ✅ 評分系統合理有效

### 5.2 性能指標
- ✅ 全市場掃描時間 ≤ 3 分鐘
- ✅ 數據更新成功率 ≥ 95%
- ✅ API 響應時間 ≤ 5 秒

### 5.3 數據準確性
- ✅ 股票數量與官方名單一致
- ✅ 歷史數據完整性 ≥ 99%
- ✅ 形態識別準確率（需人工抽樣驗證）

---

## 6. 法務授權與風險管理

### 6.1 數據來源合規
**TWSE/TPEx 官方數據**：
- 使用條款：僅限個人研究用途，禁止商業轉售
- 請求限制：遵守官方 robots.txt，請求間隔 ≥ 1秒
- 免責聲明：數據僅供參考，不構成投資建議

**FinMind 備援數據**：
- API Token：免費額度 10,000 次/月，付費升級可達 100,000 次
- 授權範圍：允許個人和小型團隊使用，需註明數據來源
- 數據延遲：免費版延遲 1 天，符合非即時交易需求

### 6.2 技術風險與對策
**數據獲取風險**：
- 風險：官方網站改版、API 變更、網站封鎖
- 對策：多重備援（TWSE → TPEx → FinMind）+ 版本檢測 + 人工介入 SOP
- 降級方案：使用前日數據 + 警告標識，最多可降級 3 天

**數據質量風險**：
- 風險：價格異常、成交量歸零、復權錯誤
- 對策：資料範圍檢查（漲跌幅 ≤ 30%）+ 前後日比對 + 異常標記
- 快取策略：7 天滾動窗口，異常數據自動標記不參與掃描

**系統可用性風險**：
- 風險：內存不足、磁盤滿載、網絡中斷
- 對策：資源監控 + 自動重啟 + 離線模式（使用本地快取）
- 災難恢復：數據備份保留 30 天，系統重建時間 ≤ 4 小時

### 6.3 業務風險控制
**投資風險警示**：
- 系統輸出必須包含風險警示：「本工具僅供技術分析參考，不構成買賣建議」
- 歷史回測免責：「歷史表現不代表未來結果」
- 參數敏感性：提供參數調整對結果影響的敏感度分析

**用戶行為約束**：
- 禁止批量爬取 API 數據進行轉售
- 系統僅供個人研究，不得用於自動交易程序
- 單用戶請求限制：100 次/分鐘，超出自動封禁 1 小時

---

## 7. 開發里程碑

### Phase 1: 核心數據管理
- 實作數據獲取模組
- 建立數據存儲結構
- 完成歷史數據回補

### Phase 2: N 字回撤算法
- 實作形態識別演算法
- 完成技術指標計算
- 建立評分系統

### Phase 3: API 服務開發
- 實作 REST API
- 完成數據接口
- API 文檔和測試

### Phase 4: 前端開發
- 實作參數設置界面
- 完成結果展示頁面
- 整合 K 線圖組件

### Phase 5: 系統整合與測試
- 端對端測試
- 性能優化
- 上線部署

---

## 7.1 回測與驗證流程

### 回測系統設計
**最小可行回測（MVP）**：
- 時間範圍：2022-01-01 至 2024-12-31（3年數據）
- 持有期間：信號觸發日 T+1 買入，持有 5/10/20 個交易日
- 基準比較：同期台股大盤指數（加權指數）
- 成交限制：假設信號日 T+1 可成交（避免 look-ahead bias）

**回測指標**：
```python
metrics = {
    "total_signals": 1247,
    "win_rate": 0.623,  # 勝率
    "avg_return_5d": 0.034,  # 5日平均報酬率
    "sharpe_ratio": 1.24,
    "max_drawdown": -0.087,
    "benchmark_excess": 0.015,  # 相對基準超額收益
    "signal_frequency": 2.3  # 平均每日信號數
}
```

### 參數驗證與穩定性測試
**參數敏感性分析**：
- 回撤比例範圍：[0.2,0.8] → [0.3,0.7] → [0.4,0.6] 對比測試
- RSI 閾值：50 vs 55 vs 60 三組對比
- 量能倍數：1.0 vs 1.5 vs 2.0 三組對比
- 最小漲幅：4% vs 5% vs 8% 三組對比

**前瞻偏差防範**：
- 嚴格時序：T-1 日收盤前計算信號，T 日收盤確認觸發，T+1 日執行
- 數據截止：計算 T 日信號時，僅使用 ≤ T-1 日的歷史數據
- 復權處理：統一使用前復權價格，避免未來調整影響歷史計算

### 人工抽樣驗證機制
**月度抽樣檢查**：
- 隨機抽取當月 20 個信號進行人工圖表驗證
- 檢查項目：ABC 點標註是否準確、觸發條件是否成立、評分合理性
- 準確率標準：ABC 識別準確率 ≥ 95%、觸發條件準確率 ≥ 98%

**參數漂移監控**：
- 每季度重新計算最佳參數組合
- 參數變動超過 ±20% 觸發告警，需人工審查決定是否調整
- 建立參數變更日誌，記錄調整原因和效果

**驗證報告格式**：
```json
{
  "validation_date": "2025-01-31",
  "sampled_signals": 20,
  "accuracy": {
    "abc_identification": 0.95,
    "trigger_conditions": 0.98,
    "score_reasonableness": 0.92
  },
  "parameter_drift": {
    "retr_min": {"old": 0.30, "optimal": 0.32, "drift_pct": 6.7},
    "rsi_threshold": {"old": 55, "optimal": 54, "drift_pct": -1.8}
  },
  "recommendations": ["調整回撤下限至 0.32", "RSI 閾值保持 55"]
}
```

---

## 8. PRD 總結與實作準備 ✅

### 8.1 核心規格確認清單
- ✅ **N 字形態定義**：使用極值價、收盤確認、最近 ABC 優先
- ✅ **觸發條件**：量增 1.5倍、RSI ≥ 55、多重觸發加分
- ✅ **時間窗口**：日 K 為主、200 根回望、可選週 K 輔助
- ✅ **數據處理**：前復權、新股 80 天門檻
- ✅ **前端設計**：7 欄位表格、150 天 K 線、豐富標註
- ✅ **系統環境**：本地 Docker、支援 4 人併發、SQLite+Parquet

### 8.2 技術架構決策
- **後端**：Python + FastAPI + Polars （高效數據處理）
- **前端**：React + TypeScript + Chart.js/TradingView （成熟生態系）
- **數據庫**：SQLite（簡單） + Parquet（效能）
- **部署**：Docker Compose（一鍵部署）

### 8.3 開發優先度
**現在可以立即開始實作！** 按 Phase 1-5 順序依序開發：
1. 🚀 **Phase 1**：數據管理模塊（TWSE/TPEx 數據獲取）
2. 🤖 **Phase 2**：N 字回撤算法實作
3. 🌐 **Phase 3**：FastAPI 服務開發
4. 🎨 **Phase 4**：React 前端實現
5. ⚙️ **Phase 5**：系統整合與測試

---

**PRD 完整度：100% ✅**  
**技術可行性：高 ✅**  
**開發準備度：就緒 🚀**